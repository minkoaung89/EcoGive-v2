{% extends 'base.html' %}

{% block title %}Register - EcoGive{% endblock %}

{% block content %}
    <div class="card p-4 mx-auto" style="max-width: 400px;">
        <h2 class="text-center mb-4">Register for EcoGive</h2>

        <form method="post" id="registerForm" novalidate>
            {% csrf_token %}
            
            <!-- Username Field -->
            <div class="mb-3">
                <label for="id_username" class="form-label">Username:</label>
                <input type="text" id="id_username" name="username" class="form-control" value="{{ form.username.value|default_if_none:'' }}" required>
                <div class="form-text">Username must only contain letters and numbers, and be at least 3 characters long.</div>
                {% if form.username.errors %}
                    {% for error in form.username.errors %}
                        <div class="text-danger small">{{ error }}</div>
                    {% endfor %}
                {% endif %}
            </div>

            <!-- Email Field -->
            <div class="mb-3">
                <label for="id_email" class="form-label">Email:</label>
                <input type="email" id="id_email" name="email" class="form-control" value="{{ form.email.value|default_if_none:'' }}" required>
                {% if form.email.errors %}
                    {% for error in form.email.errors %}
                        <div class="text-danger small">{{ error }}</div>
                    {% endfor %}
                {% endif %}
            </div>

            <!-- Password Field -->
            <div class="mb-3">
                <label for="id_password" class="form-label">Password:</label>
                <input type="password" id="id_password" name="password" class="form-control" required>
                <div class="form-text">Password must be at least 8 characters long, not entirely numeric, and should not be too common.</div>
                {% if form.password.errors %}
                    {% for error in form.password.errors %}
                        <div class="text-danger small">{{ error }}</div>
                    {% endfor %}
                {% endif %}
            </div>

            <!-- Confirm Password Field -->
            <div class="mb-3">
                <label for="confirm_password" class="form-label">Confirm Password:</label>
                <input type="password" class="form-control" id="confirm_password" name="confirm_password" placeholder="Confirm your password" required>
                <div class="text-danger small" id="passwordError" style="display: none;">Passwords do not match.</div>
            </div>

            <!-- Register Button -->
            <button type="submit" class="btn w-100" style="background-color: #098666; color: white;" id="registerButton" disabled>Register</button>
        </form>

        <p class="mt-3 text-center">
            Already have an account? <a href="{% url 'login' %}" style="color: #098666;">Login here</a>.
        </p>
    </div>

    <script>
        // JavaScript for real-time form validation
        document.addEventListener('DOMContentLoaded', () => {
            const usernameInput = document.getElementById('id_username');
            const emailInput = document.getElementById('id_email');
            const passwordInput = document.getElementById('id_password');
            const confirmPasswordInput = document.getElementById('confirm_password');
            const registerButton = document.getElementById('registerButton');
            const passwordError = document.getElementById('passwordError');

            function validateForm() {
                const username = usernameInput.value.trim();
                const email = emailInput.value.trim();
                const password = passwordInput.value;
                const confirmPassword = confirmPasswordInput.value;

                let isValid = true;

                // Username validation
                const usernamePattern = /^[a-zA-Z0-9]{3,}$/;
                if (!usernamePattern.test(username)) {
                    usernameInput.classList.add('is-invalid');
                    isValid = false;
                } else {
                    usernameInput.classList.remove('is-invalid');
                }

                // Email validation
                const emailPattern = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/; //fix after sonar scan
                if (!emailPattern.test(email)) {
                    emailInput.classList.add('is-invalid');
                    isValid = false;
                } else {
                    emailInput.classList.remove('is-invalid');
                }

                // Password validation
                if (password.length < 8) {
                    passwordInput.classList.add('is-invalid');
                    isValid = false;
                } else {
                    passwordInput.classList.remove('is-invalid');
                }

                // Confirm Password validation
                if (password === confirmPassword && confirmPassword !== '') {
                    confirmPasswordInput.classList.remove('is-invalid');
                    passwordError.style.display = 'none';   //NOSONAR as this is not hardcoded password
                } else {
                    confirmPasswordInput.classList.add('is-invalid');
                    passwordError.style.display = 'block';  //NOSONAR as this is not hardcoded password
                    isValid = false;
                }

                // Enable or disable register button
                registerButton.disabled = !isValid;
            }

            usernameInput.addEventListener('input', validateForm);
            emailInput.addEventListener('input', validateForm);
            passwordInput.addEventListener('input', validateForm);
            confirmPasswordInput.addEventListener('input', validateForm);
        });
    </script>
{% endblock %}
